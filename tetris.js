function Tile(e,t){this.isEmpty=e;this.color=t}function Point(e,t){this.raw=e;this.col=t}function ZLeftBlock(){color="Chartreuse";gridCell=blockStartPos;raw=0;col=blockStartPos;currentRotateState=0;points=new Array(new Point(0,blockStartPos),new Point(0,blockStartPos+1),new Point(1,blockStartPos+1),new Point(1,blockStartPos+2));RStates=new Array(new Array(new Point(-2,0),new Point(-1,1),new Point(0,0),new Point(1,1)),new Array(new Point(0,2),new Point(1,1),new Point(0,0),new Point(1,-1)),new Array(new Point(2,0),new Point(1,-1),new Point(0,0),new Point(-1,-1)),new Array(new Point(0,-2),new Point(-1,-1),new Point(0,0),new Point(-1,1)));this.draw()}function StairBlock(){color="Magenta";gridCell=blockStartPos;raw=0;col=blockStartPos;currentRotateState=0;points=new Array(new Point(0,blockStartPos),new Point(1,blockStartPos-1),new Point(1,blockStartPos),new Point(1,blockStartPos+1));RStates=new Array(new Array(new Point(-1,1),new Point(-1,-1),new Point(0,0),new Point(1,1)),new Array(new Point(1,1),new Point(-1,1),new Point(0,0),new Point(1,-1)),new Array(new Point(1,-1),new Point(1,1),new Point(0,0),new Point(-1,-1)),new Array(new Point(-1,-1),new Point(1,-1),new Point(0,0),new Point(-1,1)));this.draw()}function ZRightBlock(){color="Lime";gridCell=blockStartPos;raw=0;col=blockStartPos;currentRotateState=0;points=new Array(new Point(0,blockStartPos),new Point(0,blockStartPos+1),new Point(1,blockStartPos),new Point(1,blockStartPos-1));RStates=new Array(new Array(new Point(-1,1),new Point(0,2),new Point(0,0),new Point(-1,-1)),new Array(new Point(1,1),new Point(2,0),new Point(0,0),new Point(-1,1)),new Array(new Point(1,-1),new Point(0,-2),new Point(0,0),new Point(1,1)),new Array(new Point(-1,-1),new Point(-2,0),new Point(0,0),new Point(1,-1)));this.draw()}function SquareBlock(){color="Cyan";gridCell=blockStartPos;raw=0;col=blockStartPos;points=new Array(new Point(0,blockStartPos),new Point(0,blockStartPos+1),new Point(1,blockStartPos),new Point(1,blockStartPos+1));this.draw()}function LineBlock(){color="Gold";gridCell=blockStartPos;raw=0;col=blockStartPos;currentRotateState=0;points=new Array(new Point(0,blockStartPos),new Point(1,blockStartPos),new Point(2,blockStartPos),new Point(3,blockStartPos));RStates=new Array(new Array(new Point(0,1),new Point(1,0),new Point(2,-1),new Point(3,-2)),new Array(new Point(0,-1),new Point(-1,0),new Point(-2,1),new Point(-3,2)));this.draw()}function GRightBlock(){color="OrangeRed";gridCell=blockStartPos;raw=0;col=blockStartPos;currentRotateState=0;points=new Array(new Point(0,blockStartPos),new Point(0,blockStartPos+1),new Point(1,blockStartPos),new Point(2,blockStartPos));RStates=new Array(new Array(new Point(-1,1),new Point(0,2),new Point(0,0),new Point(1,-1)),new Array(new Point(1,1),new Point(2,0),new Point(0,0),new Point(-1,-1)),new Array(new Point(1,-1),new Point(0,-2),new Point(0,0),new Point(-1,1)),new Array(new Point(-1,-1),new Point(-2,0),new Point(0,0),new Point(1,1)));this.draw()}function SimpleBlock(){color="Gold";gridCell=blockStartPos;raw=0;col=blockStartPos;this.draw()}function GLeftBlock(){color="Orange";gridCell=blockStartPos;raw=0;col=blockStartPos;currentRotateState=0;points=new Array(new Point(0,blockStartPos-1),new Point(0,blockStartPos),new Point(1,blockStartPos),new Point(2,blockStartPos));RStates=new Array(new Array(new Point(-2,0),new Point(-1,1),new Point(0,0),new Point(1,-1)),new Array(new Point(0,2),new Point(1,1),new Point(0,0),new Point(-1,-1)),new Array(new Point(2,0),new Point(1,-1),new Point(0,0),new Point(-1,1)),new Array(new Point(0,-2),new Point(-1,-1),new Point(0,0),new Point(1,1)));this.draw()}function drawGrid(){var e=canvasW/2-gridSizeX/2*blockSizeX+blockSizeX;var t=startY;for(var n=0;n<gridSizeY;n++){for(var r=1;r<gridSizeX+1;r++){ctx.fillStyle="Chartreuse";ctx.clearRect(e+(r-1)*blockSizeX,startY+n*blockSizeY,blockSizeX,blockSizeY);ctx.fillStyle=grid[n][r].color;ctx.fillRect(e+(r-1)*blockSizeX,startY+n*blockSizeY,blockSizeX,blockSizeY);if(false==grid[n][r].isEmpty){ctx.strokeStyle="backgroundColor";ctx.beginPath();ctx.moveTo(e+(r-1)*blockSizeX-1,startY+n*blockSizeY);ctx.lineTo(e+(r-1)*blockSizeX+blockSizeX-1,startY+n*blockSizeY);ctx.lineTo(e+(r-1)*blockSizeX+blockSizeX-1,startY+n*blockSizeY+blockSizeY);ctx.lineTo(e+(r-1)*blockSizeX,startY+n*blockSizeY+blockSizeY);ctx.lineTo(e+(r-1)*blockSizeX,startY+n*blockSizeY);ctx.stroke()}}}}function drawBorder(){var e=canvasW/2-gridSizeX/2*blockSizeX+blockSizeX;var t=startY;ctx.fillStyle=backgroundColor;ctx.fillRect(0,0,canvasW,canvasH);ctx.strokeStyle=borderColor;ctx.lineWidth=borderThickness;ctx.beginPath();ctx.moveTo(e-borderThickness/2,startY);ctx.lineTo(e-borderThickness/2,gridSizeY*blockSizeY+borderThickness/2+startY);ctx.lineTo(e+gridSizeX*blockSizeX+borderThickness/2,gridSizeY*blockSizeY+borderThickness/2+startY);ctx.lineTo(e+gridSizeX*blockSizeX+borderThickness/2,startY);ctx.stroke()}function initGrid(){grid=new Array(gridSizeY+1);for(var e=0;e<gridSizeY+1;e++)grid[e]=new Array(gridSizeX+2);for(var e=0;e<gridSizeY+1;e++)for(var t=0;t<gridSizeX+2;t++){var n=true;if(0==t|gridSizeX+1==t)n=false;grid[e][t]=new Tile(n,backgroundColor);if(gridSizeY==e)grid[e][t].isEmpty=false}}function createNewBlock(){blockNum++;if(0==blockNum%NUMBER_OF_BLOCKS)return new SquareBlock;if(1==blockNum%NUMBER_OF_BLOCKS)return new LineBlock;if(2==blockNum%NUMBER_OF_BLOCKS)return new StairBlock;if(3==blockNum%NUMBER_OF_BLOCKS)return new ZLeftBlock;if(4==blockNum%NUMBER_OF_BLOCKS)return new ZRightBlock;if(5==blockNum%NUMBER_OF_BLOCKS)return new GRightBlock;if(6==blockNum%NUMBER_OF_BLOCKS)return new GLeftBlock}function anim(){currentBlock.movePlus(0,dy);setTimeout(anim,speed)}function checkNextGridPlace(e,t){var n=defineGridIndex(e,t);if(0==grid[n])return true;return false}function defineGridIndex(e,t){var n=(e-canvasW/2+gridSizeX/2*blockSizeX)/blockSizeX%gridSizeX;var r=(t-startY)/blockSizeY;var i=r*gridSizeX+n;return r*gridSizeX+n}function clearFullLines(){for(var e=gridSizeY-1;e>0;e--){var t=true;for(var n=1;n<gridSizeX+1;n++){if(true==grid[e][n].isEmpty)t=false}if(t){debugger;console.log("line "+e+" is full");var r=e;while(r>0){for(var n=1;n<gridSizeX+1;n++){grid[r][n].isEmpty=grid[r-1][n].isEmpty;grid[r][n].color=grid[r-1][n].color}r--}e++}}drawGrid()}var canvasW=1200;var canvasH=700;var blockSizeX=24;var blockSizeY=24;var startY=150;var startX=canvasW/2;var gridSizeX=10;var gridSizeY=20;var speed=250;var dx=canvasW/2-gridSizeX/2*blockSizeX+blockSizeX;var dy=startY;var blockStartPos=gridSizeX/2;var borderX=canvasW/2-gridSizeX/2*blockSizeX;var borderY=startY;var DOWN=0;var LEFT=1;var RIGHT=2;var NUMBER_OF_BLOCKS=7;var backgroundColor="#333333";var borderColor="#777777";var borderThickness=2;var colors=["#33ffc5","#00ce0f","#c00fff"];ZLeftBlock.prototype={draw:function(){for(var e=0;e<4;e++){ctx.fillStyle=color;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},clear:function(){for(var e=0;e<4;e++){ctx.clearRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY);ctx.fillStyle=backgroundColor;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},rotate:function(){currentRotateState++;if(4==currentRotateState)currentRotateState=0;this.clear();var e=new Array;for(var t=0;t<4;t++){e.push(new Point(points[t].raw+RStates[currentRotateState][t].raw,points[t].col+RStates[currentRotateState][t].col))}var n=0;for(var t=0;t<4;t++)if(true==grid[e[t].raw][e[t].col].isEmpty)n++;if(4==n){for(var t=0;t<4;t++){points[t].raw=e[t].raw;points[t].col=e[t].col}}else currentRotateState--;this.draw()},moveDown:function(){this.move(DOWN)},moveLeft:function(){this.move(LEFT)},moveRight:function(){this.move(RIGHT)},move:function(e){var t=false;this.clear();var n=new Array;if(DOWN==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw+1,points[r].col));if(LEFT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col-1));if(RIGHT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col+1));var i=0;for(var r=0;r<4;r++)if(true==grid[n[r].raw][n[r].col].isEmpty)i++;if(4==i)t=true;if(t){for(var r=0;r<4;r++){points[r].raw=n[r].raw;points[r].col=n[r].col}}else if(DOWN==e){for(var r=0;r<4;r++)n[r].raw--;for(var r=0;r<4;r++){grid[n[r].raw][n[r].col].isEmpty=false;grid[n[r].raw][n[r].col].color=color}clearFullLines();delete currentBlock;currentBlock=createNewBlock();drawGrid()}this.draw()}};StairBlock.prototype={draw:function(){for(var e=0;e<4;e++){ctx.fillStyle=color;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},clear:function(){for(var e=0;e<4;e++){ctx.clearRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY);ctx.fillStyle=backgroundColor;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},rotate:function(){currentRotateState++;if(4==currentRotateState)currentRotateState=0;this.clear();var e=new Array;for(var t=0;t<4;t++){e.push(new Point(points[t].raw+RStates[currentRotateState][t].raw,points[t].col+RStates[currentRotateState][t].col))}var n=0;for(var t=0;t<4;t++)if(true==grid[e[t].raw][e[t].col].isEmpty)n++;if(4==n){for(var t=0;t<4;t++){points[t].raw=e[t].raw;points[t].col=e[t].col}}else currentRotateState--;this.draw()},moveDown:function(){this.move(DOWN)},moveLeft:function(){this.move(LEFT)},moveRight:function(){this.move(RIGHT)},move:function(e){var t=false;this.clear();var n=new Array;if(DOWN==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw+1,points[r].col));if(LEFT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col-1));if(RIGHT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col+1));var i=0;for(var r=0;r<4;r++)if(true==grid[n[r].raw][n[r].col].isEmpty)i++;if(4==i)t=true;if(t){for(var r=0;r<4;r++){points[r].raw=n[r].raw;points[r].col=n[r].col}}else if(DOWN==e){for(var r=0;r<4;r++)n[r].raw--;for(var r=0;r<4;r++){grid[n[r].raw][n[r].col].isEmpty=false;grid[n[r].raw][n[r].col].color=color}clearFullLines();delete currentBlock;currentBlock=createNewBlock();drawGrid()}this.draw()}};ZRightBlock.prototype={draw:function(){for(var e=0;e<4;e++){ctx.fillStyle=color;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},clear:function(){for(var e=0;e<4;e++){ctx.clearRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY);ctx.fillStyle=backgroundColor;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},rotate:function(){currentRotateState++;if(4==currentRotateState)currentRotateState=0;this.clear();var e=new Array;for(var t=0;t<4;t++){e.push(new Point(points[t].raw+RStates[currentRotateState][t].raw,points[t].col+RStates[currentRotateState][t].col))}var n=0;for(var t=0;t<4;t++)if(true==grid[e[t].raw][e[t].col].isEmpty)n++;if(4==n){for(var t=0;t<4;t++){points[t].raw=e[t].raw;points[t].col=e[t].col}}else currentRotateState--;this.draw()},moveDown:function(){this.move(DOWN)},moveLeft:function(){this.move(LEFT)},moveRight:function(){this.move(RIGHT)},move:function(e){var t=false;this.clear();var n=new Array;if(DOWN==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw+1,points[r].col));if(LEFT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col-1));if(RIGHT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col+1));var i=0;for(var r=0;r<4;r++)if(true==grid[n[r].raw][n[r].col].isEmpty)i++;if(4==i)t=true;if(t){for(var r=0;r<4;r++){points[r].raw=n[r].raw;points[r].col=n[r].col}}else if(DOWN==e){for(var r=0;r<4;r++)n[r].raw--;for(var r=0;r<4;r++){grid[n[r].raw][n[r].col].isEmpty=false;grid[n[r].raw][n[r].col].color=color}clearFullLines();delete currentBlock;currentBlock=createNewBlock();drawGrid()}this.draw()}};SquareBlock.prototype={draw:function(){for(var e=0;e<4;e++){ctx.fillStyle=color;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},clear:function(){for(var e=0;e<4;e++){ctx.clearRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY);ctx.fillStyle=backgroundColor;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},rotate:function(){},moveDown:function(){this.move(DOWN)},moveLeft:function(){this.move(LEFT)},moveRight:function(){this.move(RIGHT)},move:function(e){var t=false;this.clear();var n=new Array;if(DOWN==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw+1,points[r].col));if(LEFT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col-1));if(RIGHT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col+1));var i=0;for(var r=0;r<4;r++)if(true==grid[n[r].raw][n[r].col].isEmpty)i++;if(4==i)t=true;if(t){for(var r=0;r<4;r++){points[r].raw=n[r].raw;points[r].col=n[r].col}}else if(DOWN==e){for(var r=0;r<4;r++)n[r].raw--;for(var r=0;r<4;r++){grid[n[r].raw][n[r].col].isEmpty=false;grid[n[r].raw][n[r].col].color=color}clearFullLines();delete currentBlock;currentBlock=createNewBlock();drawGrid()}this.draw()}};LineBlock.prototype={draw:function(){for(var e=0;e<4;e++){ctx.fillStyle=color;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},clear:function(){for(var e=0;e<4;e++){ctx.clearRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY);ctx.fillStyle=backgroundColor;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},rotate:function(){currentRotateState++;if(4==currentRotateState)currentRotateState=0;this.clear();var e=new Array;for(var t=0;t<4;t++){e.push(new Point(points[t].raw+RStates[currentRotateState][t].raw,points[t].col+RStates[currentRotateState][t].col))}var n=0;for(var t=0;t<4;t++)if(e[t].raw<gridSizeX&&e[t].col<gridSizeY)n++;n=-1;if(-1!=n)for(var t=0;t<4;t++)if(true==grid[e[t].raw][e[t].col].isEmpty)n++;if(4==n){for(var t=0;t<4;t++){points[t].raw=e[t].raw;points[t].col=e[t].col}}else currentRotateState--;this.draw()},moveDown:function(){this.move(DOWN)},moveLeft:function(){this.move(LEFT)},moveRight:function(){this.move(RIGHT)},move:function(e){var t=false;this.clear();var n=new Array;if(DOWN==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw+1,points[r].col));if(LEFT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col-1));if(RIGHT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col+1));var i=0;for(var r=0;r<4;r++)if(true==grid[n[r].raw][n[r].col].isEmpty)i++;if(4==i)t=true;if(t){for(var r=0;r<4;r++){points[r].raw=n[r].raw;points[r].col=n[r].col}}else if(DOWN==e){for(var r=0;r<4;r++)n[r].raw--;for(var r=0;r<4;r++){grid[n[r].raw][n[r].col].isEmpty=false;grid[n[r].raw][n[r].col].color=color}clearFullLines();delete currentBlock;currentBlock=createNewBlock();drawGrid()}this.draw()}};GRightBlock.prototype={draw:function(){for(var e=0;e<4;e++){ctx.fillStyle=color;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},clear:function(){for(var e=0;e<4;e++){ctx.clearRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY);ctx.fillStyle=backgroundColor;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},rotate:function(){currentRotateState++;if(4==currentRotateState)currentRotateState=0;this.clear();var e=new Array;for(var t=0;t<4;t++){e.push(new Point(points[t].raw+RStates[currentRotateState][t].raw,points[t].col+RStates[currentRotateState][t].col))}var n=0;for(var t=0;t<4;t++)if(true==grid[e[t].raw][e[t].col].isEmpty)n++;if(4==n){for(var t=0;t<4;t++){points[t].raw=e[t].raw;points[t].col=e[t].col}}else currentRotateState--;this.draw()},moveDown:function(){this.move(DOWN)},moveLeft:function(){this.move(LEFT)},moveRight:function(){this.move(RIGHT)},move:function(e){var t=false;this.clear();var n=new Array;if(DOWN==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw+1,points[r].col));if(LEFT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col-1));if(RIGHT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col+1));var i=0;for(var r=0;r<4;r++)if(true==grid[n[r].raw][n[r].col].isEmpty)i++;if(4==i)t=true;if(t){for(var r=0;r<4;r++){points[r].raw=n[r].raw;points[r].col=n[r].col}}else if(DOWN==e){for(var r=0;r<4;r++)n[r].raw--;for(var r=0;r<4;r++){grid[n[r].raw][n[r].col].isEmpty=false;grid[n[r].raw][n[r].col].color=color}clearFullLines();delete currentBlock;currentBlock=createNewBlock();drawGrid()}this.draw()}};SimpleBlock.prototype={draw:function(){ctx.fillStyle=color;ctx.fillRect(borderX+col*blockSizeX,borderY+raw*blockSizeY,blockSizeX,blockSizeY)},clear:function(){ctx.clearRect(borderX+col*blockSizeX,borderY+raw*blockSizeY,blockSizeX,blockSizeY);ctx.fillStyle=backgroundColor;ctx.fillRect(borderX+col*blockSizeX,borderY+raw*blockSizeY,blockSizeX,blockSizeY)},moveDown:function(){this.move(DOWN)},moveLeft:function(){this.move(LEFT)},moveRight:function(){this.move(RIGHT)},move:function(e){var t=false;var n=false;var r=false;this.clear();if(DOWN==e)raw++;if(LEFT==e)col--;if(RIGHT==e)col++;if(col>-1&&col<gridSizeX&&raw<gridSizeY){if(true==grid[raw*gridSizeX+col].isEmpty){t=true;this.draw()}}else n=true;if(true==n){if(DOWN==e)raw--;if(LEFT==e)col++;if(RIGHT==e)col--;gridCell=raw*gridSizeX+col;this.draw();if(gridSizeY-1==raw){grid[gridCell].isEmpty=false;grid[gridCell].color=this.color;clearFullLines();delete currentBlock;currentBlock=createNewBlock()}console.log("outOfBounds; raw = "+raw+" "+gridCell)}if(false==t&&false==n){if(DOWN==e){if(DOWN==e)raw--;if(LEFT==e)col++;if(RIGHT==e)col--;gridCell=raw*gridSizeX+col;this.draw();grid[gridCell].isEmpty=false;grid[gridCell].color=this.color;clearFullLines();delete currentBlock;currentBlock=createNewBlock()}else{if(LEFT==e)col++;if(RIGHT==e)col--;this.draw()}}}};GLeftBlock.prototype={draw:function(){for(var e=0;e<4;e++){ctx.fillStyle=color;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},clear:function(){for(var e=0;e<4;e++){ctx.clearRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY);ctx.fillStyle=backgroundColor;ctx.fillRect(borderX+points[e].col*blockSizeX,borderY+points[e].raw*blockSizeY,blockSizeX,blockSizeY)}},rotate:function(){currentRotateState++;if(4==currentRotateState)currentRotateState=0;this.clear();var e=new Array;for(var t=0;t<4;t++){e.push(new Point(points[t].raw+RStates[currentRotateState][t].raw,points[t].col+RStates[currentRotateState][t].col))}var n=0;for(var t=0;t<4;t++)if(true==grid[e[t].raw][e[t].col].isEmpty)n++;if(4==n){for(var t=0;t<4;t++){points[t].raw=e[t].raw;points[t].col=e[t].col}}else currentRotateState--;this.draw()},moveDown:function(){this.move(DOWN)},moveLeft:function(){this.move(LEFT)},moveRight:function(){this.move(RIGHT)},move:function(e){var t=false;this.clear();var n=new Array;if(DOWN==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw+1,points[r].col));if(LEFT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col-1));if(RIGHT==e)for(var r=0;r<4;r++)n.push(new Point(points[r].raw,points[r].col+1));var i=0;for(var r=0;r<4;r++)if(true==grid[n[r].raw][n[r].col].isEmpty)i++;if(4==i)t=true;if(t){for(var r=0;r<4;r++){points[r].raw=n[r].raw;points[r].col=n[r].col}}else if(DOWN==e){for(var r=0;r<4;r++)n[r].raw--;for(var r=0;r<4;r++){grid[n[r].raw][n[r].col].isEmpty=false;grid[n[r].raw][n[r].col].color=color}clearFullLines();delete currentBlock;currentBlock=createNewBlock();drawGrid()}this.draw()}};document.onkeydown=function(e){e=e||event;switch(e.keyCode){case 38:currentBlock.rotate();break;case 40:currentBlock.moveDown();break;case 37:currentBlock.moveLeft();break;case 39:currentBlock.moveRight();break}};var ex=document.getElementById("ex");var ctx=ex.getContext("2d");ex.width=canvasW;ex.height=canvasH;var blockNum=0;var grid;initGrid();drawBorder();drawGrid();var currentBlock=createNewBlock()